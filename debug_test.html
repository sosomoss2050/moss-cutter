<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MossCutter è°ƒè¯•æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .debug-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #e11d48;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-area {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            text-align: center;
        }
        
        .test-button {
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .test-button:hover {
            background: #2563eb;
        }
        
        .test-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .console {
            background: #1f2937;
            color: #f3f4f6;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .console-line {
            margin: 5px 0;
            padding: 5px 10px;
            border-left: 3px solid transparent;
        }
        
        .console-line.info {
            border-left-color: #3b82f6;
            color: #93c5fd;
        }
        
        .console-line.success {
            border-left-color: #10b981;
            color: #a7f3d0;
        }
        
        .console-line.error {
            border-left-color: #ef4444;
            color: #fca5a5;
        }
        
        .console-line.warning {
            border-left-color: #f59e0b;
            color: #fde68a;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>ğŸ› ï¸ MossCutter å®æ—¶è°ƒè¯•æµ‹è¯•</h1>
        
        <div class="test-area">
            <h3>æµ‹è¯•1: æ£€æŸ¥JavaScripté”™è¯¯</h3>
            <button class="test-button" onclick="checkForErrors()">æ£€æŸ¥é”™è¯¯</button>
            <button class="test-button" onclick="clearConsole()">æ¸…ç©ºæ§åˆ¶å°</button>
        </div>
        
        <div class="test-area">
            <h3>æµ‹è¯•2: æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œ</h3>
            <button class="test-button" onclick="simulateUpload()">æ¨¡æ‹Ÿä¸Šä¼ å›¾ç‰‡</button>
            <button class="test-button" onclick="simulateGridChange()">æ¨¡æ‹Ÿç½‘æ ¼å˜åŒ–</button>
            <button class="test-button" onclick="simulateCut()">æ¨¡æ‹Ÿåˆ‡å‰²</button>
        </div>
        
        <div class="test-area">
            <h3>æµ‹è¯•3: æ£€æŸ¥åŠŸèƒ½çŠ¶æ€</h3>
            <button class="test-button" onclick="checkButtonStates()">æ£€æŸ¥æŒ‰é’®çŠ¶æ€</button>
            <button class="test-button" onclick="checkEventListeners()">æ£€æŸ¥äº‹ä»¶ç›‘å¬</button>
            <button class="test-button" onclick="checkVariables()">æ£€æŸ¥å˜é‡</button>
        </div>
        
        <div class="console" id="console">
            <div class="console-line info">æ§åˆ¶å°å·²å°±ç»ªã€‚ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•ã€‚</div>
            <div class="console-line info">å½“å‰æ—¶é—´: <span id="currentTime"></span></div>
        </div>
    </div>
    
    <script>
        const consoleElement = document.getElementById('console');
        const currentTimeElement = document.getElementById('currentTime');
        
        // æ›´æ–°æ—¶é—´
        function updateTime() {
            currentTimeElement.textContent = new Date().toLocaleTimeString();
        }
        setInterval(updateTime, 1000);
        updateTime();
        
        // æ—¥å¿—å‡½æ•°
        function log(type, message) {
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleElement.appendChild(line);
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }
        
        function clearConsole() {
            consoleElement.innerHTML = '';
            log('info', 'æ§åˆ¶å°å·²æ¸…ç©º');
        }
        
        // æµ‹è¯•å‡½æ•°
        function checkForErrors() {
            log('info', 'å¼€å§‹æ£€æŸ¥JavaScripté”™è¯¯...');
            
            // æ£€æŸ¥å…¨å±€é”™è¯¯
            window.onerror = function(msg, url, line, col, error) {
                log('error', `å…¨å±€é”™è¯¯: ${msg} (${url}:${line}:${col})`);
                return false;
            };
            
            // æ£€æŸ¥æœªæ•è·çš„Promiseé”™è¯¯
            window.addEventListener('unhandledrejection', function(event) {
                log('error', `Promiseé”™è¯¯: ${event.reason}`);
            });
            
            // å°è¯•æ‰§è¡Œä¸€äº›ä»£ç æ¥è§¦å‘é”™è¯¯
            try {
                // æ£€æŸ¥é‡å¤å˜é‡
                log('info', 'æ£€æŸ¥å˜é‡å£°æ˜...');
                
                // æ£€æŸ¥ä¸»è„šæœ¬æ˜¯å¦åŠ è½½
                const mainScript = document.querySelector('script[src*="script.js"]');
                if (mainScript) {
                    log('success', 'ä¸»è„šæœ¬å·²åŠ è½½');
                } else {
                    log('error', 'ä¸»è„šæœ¬æœªæ‰¾åˆ°');
                }
                
                // æ£€æŸ¥å¤–éƒ¨åº“
                if (typeof JSZip !== 'undefined') {
                    log('success', 'JSZipåº“å·²åŠ è½½');
                } else {
                    log('warning', 'JSZipåº“æœªåŠ è½½ï¼ˆå¯èƒ½è¿˜åœ¨åŠ è½½ä¸­ï¼‰');
                }
                
                log('success', 'åŸºæœ¬æ£€æŸ¥å®Œæˆ');
                
            } catch (error) {
                log('error', `æ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`);
            }
        }
        
        function simulateUpload() {
            log('info', 'æ¨¡æ‹Ÿä¸Šä¼ å›¾ç‰‡...');
            
            try {
                // æ£€æŸ¥ä¸Šä¼ ç›¸å…³å…ƒç´ 
                const fileInput = document.getElementById('fileInput');
                const selectFileBtn = document.getElementById('selectFileBtn');
                const uploadArea = document.getElementById('uploadArea');
                
                if (fileInput && selectFileBtn && uploadArea) {
                    log('success', 'ä¸Šä¼ ç›¸å…³å…ƒç´ å­˜åœ¨');
                    
                    // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨
                    if (selectFileBtn.onclick || selectFileBtn.hasAttribute('onclick')) {
                        log('success', 'é€‰æ‹©æ–‡ä»¶æŒ‰é’®æœ‰ç‚¹å‡»äº‹ä»¶');
                    } else {
                        log('warning', 'é€‰æ‹©æ–‡ä»¶æŒ‰é’®æ²¡æœ‰ç‚¹å‡»äº‹ä»¶ï¼ˆå¯èƒ½é€šè¿‡addEventListeneræ·»åŠ ï¼‰');
                    }
                    
                    // æ¨¡æ‹Ÿç‚¹å‡»é€‰æ‹©æ–‡ä»¶æŒ‰é’®
                    log('info', 'æ¨¡æ‹Ÿç‚¹å‡»é€‰æ‹©æ–‡ä»¶æŒ‰é’®...');
                    selectFileBtn.click();
                    
                } else {
                    log('error', 'ä¸Šä¼ ç›¸å…³å…ƒç´ ç¼ºå¤±');
                    if (!fileInput) log('error', 'fileInput æœªæ‰¾åˆ°');
                    if (!selectFileBtn) log('error', 'selectFileBtn æœªæ‰¾åˆ°');
                    if (!uploadArea) log('error', 'uploadArea æœªæ‰¾åˆ°');
                }
                
            } catch (error) {
                log('error', `æ¨¡æ‹Ÿä¸Šä¼ å¤±è´¥: ${error.message}`);
            }
        }
        
        function simulateGridChange() {
            log('info', 'æ¨¡æ‹Ÿç½‘æ ¼è®¾ç½®å˜åŒ–...');
            
            try {
                const rowsInput = document.getElementById('rows');
                const colsInput = document.getElementById('cols');
                const presetButtons = document.querySelectorAll('.preset-buttons .btn');
                
                if (rowsInput && colsInput) {
                    log('success', 'ç½‘æ ¼è¾“å…¥æ¡†å­˜åœ¨');
                    
                    // æµ‹è¯•è¾“å…¥æ¡†
                    rowsInput.value = 4;
                    colsInput.value = 4;
                    
                    // è§¦å‘inputäº‹ä»¶
                    rowsInput.dispatchEvent(new Event('input', { bubbles: true }));
                    colsInput.dispatchEvent(new Event('input', { bubbles: true }));
                    
                    log('info', `è®¾ç½®ç½‘æ ¼ä¸º: ${rowsInput.value}Ã—${colsInput.value}`);
                    
                } else {
                    log('error', 'ç½‘æ ¼è¾“å…¥æ¡†ç¼ºå¤±');
                }
                
                if (presetButtons.length > 0) {
                    log('success', `æ‰¾åˆ° ${presetButtons.length} ä¸ªé¢„è®¾æŒ‰é’®`);
                    
                    // æµ‹è¯•ç¬¬ä¸€ä¸ªé¢„è®¾æŒ‰é’®
                    const firstButton = presetButtons[0];
                    log('info', `æµ‹è¯•é¢„è®¾æŒ‰é’®: ${firstButton.textContent.trim()}`);
                    
                } else {
                    log('warning', 'æœªæ‰¾åˆ°é¢„è®¾æŒ‰é’®');
                }
                
            } catch (error) {
                log('error', `æ¨¡æ‹Ÿç½‘æ ¼å˜åŒ–å¤±è´¥: ${error.message}`);
            }
        }
        
        function simulateCut() {
            log('info', 'æ¨¡æ‹Ÿåˆ‡å‰²æ“ä½œ...');
            
            try {
                const cutBtn = document.getElementById('cutBtn');
                
                if (cutBtn) {
                    log('success', 'åˆ‡å‰²æŒ‰é’®å­˜åœ¨');
                    
                    if (cutBtn.disabled) {
                        log('warning', 'åˆ‡å‰²æŒ‰é’®å½“å‰ç¦ç”¨ï¼ˆéœ€è¦å…ˆä¸Šä¼ å›¾ç‰‡ï¼‰');
                    } else {
                        log('info', 'åˆ‡å‰²æŒ‰é’®å·²å¯ç”¨ï¼Œæ¨¡æ‹Ÿç‚¹å‡»...');
                        cutBtn.click();
                    }
                    
                } else {
                    log('error', 'åˆ‡å‰²æŒ‰é’®æœªæ‰¾åˆ°');
                }
                
            } catch (error) {
                log('error', `æ¨¡æ‹Ÿåˆ‡å‰²å¤±è´¥: ${error.message}`);
            }
        }
        
        function checkButtonStates() {
            log('info', 'æ£€æŸ¥æŒ‰é’®çŠ¶æ€...');
            
            const buttonsToCheck = [
                'selectFileBtn', 'cutBtn', 'resetBtn', 
                'toggleAdvanced', 'downloadBtn'
            ];
            
            buttonsToCheck.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    const state = button.disabled ? 'ç¦ç”¨' : 'å¯ç”¨';
                    const color = button.disabled ? 'warning' : 'success';
                    log(color, `${buttonId}: ${state} (${button.textContent.trim()})`);
                } else {
                    log('error', `${buttonId}: æœªæ‰¾åˆ°`);
                }
            });
        }
        
        function checkEventListeners() {
            log('info', 'æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨ï¼ˆé€šè¿‡æ¨¡æ‹Ÿæ“ä½œï¼‰...');
            
            // è¿™ä¸ªæ–¹æ³•æ— æ³•ç›´æ¥è·å–äº‹ä»¶ç›‘å¬å™¨åˆ—è¡¨
            // ä½†æˆ‘ä»¬å¯ä»¥æ£€æŸ¥å…ƒç´ æ˜¯å¦æœ‰ç›¸åº”çš„äº‹ä»¶å±æ€§
            const elementsToCheck = [
                { id: 'selectFileBtn', event: 'onclick' },
                { id: 'cutBtn', event: 'onclick' },
                { id: 'resetBtn', event: 'onclick' },
                { id: 'rows', event: 'oninput' },
                { id: 'cols', event: 'oninput' }
            ];
            
            elementsToCheck.forEach(item => {
                const element = document.getElementById(item.id);
                if (element) {
                    const hasDirectHandler = element[item.event] !== null;
                    log('info', `${item.id}: å…ƒç´ å­˜åœ¨${hasDirectHandler ? 'ï¼Œæœ‰ç›´æ¥äº‹ä»¶å¤„ç†' : 'ï¼Œæ— ç›´æ¥äº‹ä»¶å¤„ç†ï¼ˆå¯èƒ½é€šè¿‡addEventListenerï¼‰'}`);
                } else {
                    log('error', `${item.id}: å…ƒç´ æœªæ‰¾åˆ°`);
                }
            });
        }
        
        function checkVariables() {
            log('info', 'æ£€æŸ¥å…¨å±€å˜é‡...');
            
            // æ£€æŸ¥MossCutterçš„ä¸»è¦å˜é‡
            const mossVars = [
                'originalImage', 'canvas', 'ctx', 'gridOverlay',
                'currentRows', 'currentCols'
            ];
            
            mossVars.forEach(varName => {
                try {
                    if (window[varName] !== undefined) {
                        const type = typeof window[varName];
                        const value = window[varName] === null ? 'null' : 
                                     window[varName] === undefined ? 'undefined' : 
                                     type === 'object' ? 'object' : window[varName];
                        log('success', `${varName}: ${type} = ${value}`);
                    } else {
                        log('warning', `${varName}: æœªå®šä¹‰`);
                    }
                } catch (error) {
                    log('error', `${varName}: æ£€æŸ¥å¤±è´¥ - ${error.message}`);
                }
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºæœ¬æ£€æŸ¥
        window.addEventListener('DOMContentLoaded', () => {
            log('info', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æ£€æŸ¥...');
            setTimeout(checkForErrors, 500);
            setTimeout(checkButtonStates, 1000);
        });
        
        // æ•è·æ§åˆ¶å°è¾“å‡º
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            log('info', args.join(' '));
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            log('error', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            log('warning', args.join(' '));
        };
    </script>
</body>
</html>